{"version":3,"file":"index.mjs","sources":["../../../../../packages/directives/click-outside/index.ts"],"sourcesContent":["import { isArray, isClient, isElement } from '@element-plus/utils'\n\nimport type {\n  ComponentPublicInstance,\n  DirectiveBinding,\n  ObjectDirective,\n} from 'vue'\n\ntype DocumentHandler = <T extends MouseEvent>(mouseup: T, mousedown: T) => void\ntype FlushList = Map<\n  HTMLElement,\n  {\n    documentHandler: DocumentHandler\n    bindingFn: (...args: unknown[]) => unknown\n  }[]\n>\n\nconst nodeList: FlushList = new Map()\n\nif (isClient) {\n  let startClick: MouseEvent | undefined\n  document.addEventListener('mousedown', (e: MouseEvent) => (startClick = e))\n  document.addEventListener('mouseup', (e: MouseEvent) => {\n    if (startClick) {\n      for (const handlers of nodeList.values()) {\n        for (const { documentHandler } of handlers) {\n          documentHandler(e as MouseEvent, startClick)\n        }\n      }\n      startClick = undefined\n    }\n  })\n}\n\nfunction createDocumentHandler(\n  el: HTMLElement,\n  binding: DirectiveBinding\n): DocumentHandler {\n  let excludes: HTMLElement[] = []\n  if (isArray(binding.arg)) {\n    excludes = binding.arg\n  } else if (isElement(binding.arg)) {\n    // due to current implementation on binding type is wrong the type casting is necessary here\n    excludes.push(binding.arg as unknown as HTMLElement)\n  }\n  return function (mouseup, mousedown) {\n    const popperRef = (\n      binding.instance as ComponentPublicInstance<{\n        popperRef: HTMLElement\n      }>\n    ).popperRef\n    const mouseUpTarget = mouseup.target as Node\n    const mouseDownTarget = mousedown?.target as Node\n    const isBound = !binding || !binding.instance\n    const isTargetExists = !mouseUpTarget || !mouseDownTarget\n    const isContainedByEl =\n      el.contains(mouseUpTarget) || el.contains(mouseDownTarget)\n    const isSelf = el === mouseUpTarget\n\n    const isTargetExcluded =\n      (excludes.length &&\n        excludes.some((item) => item?.contains(mouseUpTarget))) ||\n      (excludes.length && excludes.includes(mouseDownTarget as HTMLElement))\n    const isContainedByPopper =\n      popperRef &&\n      (popperRef.contains(mouseUpTarget) || popperRef.contains(mouseDownTarget))\n    if (\n      isBound ||\n      isTargetExists ||\n      isContainedByEl ||\n      isSelf ||\n      isTargetExcluded ||\n      isContainedByPopper\n    ) {\n      return\n    }\n    binding.value(mouseup, mousedown)\n  }\n}\n\nconst ClickOutside: ObjectDirective<HTMLElement, any> = {\n  beforeMount(el, binding) {\n    // there could be multiple handlers on the element\n    if (!nodeList.has(el)) {\n      nodeList.set(el, [])\n    }\n\n    nodeList.get(el)!.push({\n      documentHandler: createDocumentHandler(el, binding),\n      bindingFn: binding.value,\n    })\n  },\n  updated(el, binding) {\n    if (!nodeList.has(el)) {\n      nodeList.set(el, [])\n    }\n\n    const handlers = nodeList.get(el)!\n    const oldHandlerIndex = handlers.findIndex(\n      (item) => item.bindingFn === binding.oldValue\n    )\n    const newHandler = {\n      documentHandler: createDocumentHandler(el, binding),\n      bindingFn: binding.value,\n    }\n\n    if (oldHandlerIndex >= 0) {\n      // replace the old handler to the new handler\n      handlers.splice(oldHandlerIndex, 1, newHandler)\n    } else {\n      handlers.push(newHandler)\n    }\n  },\n  unmounted(el) {\n    // remove all listeners when a component unmounted\n    nodeList.delete(el)\n  },\n}\n\nexport default ClickOutside\n"],"names":[],"mappings":"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"}