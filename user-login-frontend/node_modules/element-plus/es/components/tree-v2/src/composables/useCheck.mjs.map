{"version":3,"file":"useCheck.mjs","sources":["../../../../../../../packages/components/tree-v2/src/composables/useCheck.ts"],"sourcesContent":["import { getCurrentInstance, nextTick, ref, watch } from 'vue'\nimport {\n  NODE_CHECK,\n  NODE_CHECK_CHANGE,\n  SetOperationEnum,\n} from '../virtual-tree'\n\nimport type { CheckboxValueType } from '@element-plus/components/checkbox'\nimport type { Ref } from 'vue'\nimport type { Tree, TreeKey, TreeNode, TreeNodeData, TreeProps } from '../types'\n\nexport function useCheck(props: TreeProps, tree: Ref<Tree | undefined>) {\n  const checkedKeys = ref<Set<TreeKey>>(new Set())\n  const indeterminateKeys = ref<Set<TreeKey>>(new Set())\n  const { emit } = getCurrentInstance()!\n\n  watch(\n    [() => tree.value, () => props.defaultCheckedKeys],\n    () => {\n      return nextTick(() => {\n        _setCheckedKeys(props.defaultCheckedKeys!)\n      })\n    },\n    {\n      immediate: true,\n    }\n  )\n\n  const updateCheckedKeys = () => {\n    if (!tree.value || !props.showCheckbox || props.checkStrictly) {\n      return\n    }\n    const { levelTreeNodeMap, maxLevel } = tree.value\n    const checkedKeySet = checkedKeys.value\n    const indeterminateKeySet = new Set<TreeKey>()\n    // It is easier to determine the indeterminate state by\n    // traversing from bottom to top\n    // leaf nodes not have indeterminate status and can be skipped\n    for (let level = maxLevel; level >= 1; --level) {\n      const nodes = levelTreeNodeMap.get(level)\n      if (!nodes) continue\n      nodes.forEach((node) => {\n        const children = node.children\n        let isEffectivelyChecked =\n          !node.isLeaf || node.disabled || checkedKeySet.has(node.key)\n        if (children) {\n          // Whether all child nodes are selected\n          let allChecked = true\n          // Whether a child node is selected\n          let hasChecked = false\n          for (const childNode of children) {\n            const key = childNode.key\n            if (!childNode.isEffectivelyChecked) {\n              isEffectivelyChecked = false\n            }\n            if (checkedKeySet.has(key)) {\n              hasChecked = true\n            } else if (indeterminateKeySet.has(key)) {\n              allChecked = false\n              hasChecked = true\n              break\n            } else {\n              allChecked = false\n            }\n          }\n          if (allChecked) {\n            checkedKeySet.add(node.key)\n          } else if (hasChecked) {\n            indeterminateKeySet.add(node.key)\n            checkedKeySet.delete(node.key)\n          } else {\n            checkedKeySet.delete(node.key)\n            indeterminateKeySet.delete(node.key)\n          }\n        }\n        node.isEffectivelyChecked = isEffectivelyChecked\n      })\n    }\n    indeterminateKeys.value = indeterminateKeySet\n  }\n\n  const isChecked = (node: TreeNode) => checkedKeys.value.has(node.key)\n\n  const isIndeterminate = (node: TreeNode) =>\n    indeterminateKeys.value.has(node.key)\n\n  const toggleCheckbox = (\n    node: TreeNode,\n    isChecked: CheckboxValueType,\n    nodeClick = true,\n    immediateUpdate = true\n  ) => {\n    const checkedKeySet = checkedKeys.value\n    const children = node.children\n    if (!props.checkStrictly && nodeClick && children?.length) {\n      isChecked = children.some((node) => !node.isEffectivelyChecked)\n    }\n\n    const toggle = (node: TreeNode, checked: CheckboxValueType) => {\n      checkedKeySet[checked ? SetOperationEnum.ADD : SetOperationEnum.DELETE](\n        node.key\n      )\n      const children = node.children\n      if (!props.checkStrictly && children) {\n        children.forEach((childNode) => {\n          if (!childNode.disabled || childNode.children) {\n            toggle(childNode, checked)\n          }\n        })\n      }\n    }\n    toggle(node, isChecked)\n    if (immediateUpdate) {\n      updateCheckedKeys()\n    }\n    if (nodeClick) {\n      afterNodeCheck(node, isChecked)\n    }\n  }\n\n  const afterNodeCheck = (node: TreeNode, checked: CheckboxValueType) => {\n    const { checkedNodes, checkedKeys } = getChecked()\n    const { halfCheckedNodes, halfCheckedKeys } = getHalfChecked()\n    emit(NODE_CHECK, node.data, {\n      checkedKeys,\n      checkedNodes,\n      halfCheckedKeys,\n      halfCheckedNodes,\n    })\n    emit(NODE_CHECK_CHANGE, node.data, checked)\n  }\n\n  // expose\n  function getCheckedKeys(leafOnly = false): TreeKey[] {\n    return getChecked(leafOnly).checkedKeys\n  }\n\n  function getCheckedNodes(leafOnly = false): TreeNodeData[] {\n    return getChecked(leafOnly).checkedNodes\n  }\n\n  function getHalfCheckedKeys(): TreeKey[] {\n    return getHalfChecked().halfCheckedKeys\n  }\n\n  function getHalfCheckedNodes(): TreeNodeData[] {\n    return getHalfChecked().halfCheckedNodes\n  }\n\n  function getChecked(leafOnly = false): {\n    checkedKeys: TreeKey[]\n    checkedNodes: TreeNodeData[]\n  } {\n    const checkedNodes: TreeNodeData[] = []\n    const keys: TreeKey[] = []\n    if (tree?.value && props.showCheckbox) {\n      const { treeNodeMap } = tree.value\n      checkedKeys.value.forEach((key) => {\n        const node = treeNodeMap.get(key)\n        if (node && (!leafOnly || (leafOnly && node.isLeaf))) {\n          keys.push(key)\n          checkedNodes.push(node.data)\n        }\n      })\n    }\n    return {\n      checkedKeys: keys,\n      checkedNodes,\n    }\n  }\n\n  function getHalfChecked(): {\n    halfCheckedKeys: TreeKey[]\n    halfCheckedNodes: TreeNodeData[]\n  } {\n    const halfCheckedNodes: TreeNodeData[] = []\n    const halfCheckedKeys: TreeKey[] = []\n    if (tree?.value && props.showCheckbox) {\n      const { treeNodeMap } = tree.value\n      indeterminateKeys.value.forEach((key) => {\n        const node = treeNodeMap.get(key)\n        if (node) {\n          halfCheckedKeys.push(key)\n          halfCheckedNodes.push(node.data)\n        }\n      })\n    }\n    return {\n      halfCheckedNodes,\n      halfCheckedKeys,\n    }\n  }\n\n  function setCheckedKeys(keys: TreeKey[]) {\n    checkedKeys.value.clear()\n    indeterminateKeys.value.clear()\n    nextTick(() => {\n      _setCheckedKeys(keys)\n    })\n  }\n\n  function setChecked(key: TreeKey, isChecked: boolean) {\n    if (tree?.value && props.showCheckbox) {\n      const node = tree.value.treeNodeMap.get(key)\n      if (node) {\n        toggleCheckbox(node, isChecked, false)\n      }\n    }\n  }\n\n  function _setCheckedKeys(keys: TreeKey[]) {\n    if (tree?.value) {\n      const { treeNodeMap } = tree.value\n      if (props.showCheckbox && treeNodeMap && keys?.length > 0) {\n        for (const key of keys) {\n          const node = treeNodeMap.get(key)\n          if (node && !isChecked(node)) {\n            toggleCheckbox(node, true, false, false)\n          }\n        }\n        updateCheckedKeys()\n      }\n    }\n  }\n\n  return {\n    updateCheckedKeys,\n    toggleCheckbox,\n    isChecked,\n    isIndeterminate,\n    // expose\n    getCheckedKeys,\n    getCheckedNodes,\n    getHalfCheckedKeys,\n    getHalfCheckedNodes,\n    setChecked,\n    setCheckedKeys,\n  }\n}\n"],"names":["isChecked","node","children","checkedKeys"],"mappings":"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"}