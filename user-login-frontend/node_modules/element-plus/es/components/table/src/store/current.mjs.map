{"version":3,"file":"current.mjs","sources":["../../../../../../../packages/components/table/src/store/current.ts"],"sourcesContent":["import { getCurrentInstance, ref, unref } from 'vue'\nimport { getRowIdentity } from '../util'\n\nimport type { Ref } from 'vue'\nimport type { DefaultRow, Table } from '../table/defaults'\nimport type { WatcherPropsData } from '.'\n\nfunction useCurrent<T extends DefaultRow>(watcherData: WatcherPropsData<T>) {\n  const instance = getCurrentInstance() as Table<T>\n  const _currentRowKey: Ref<string | null> = ref(null)\n  const currentRow: Ref<T | null> = ref(null)\n\n  const setCurrentRowKey = (key: string) => {\n    instance.store.assertRowKey()\n    _currentRowKey.value = key\n    setCurrentRowByKey(key)\n  }\n\n  const restoreCurrentRowKey = () => {\n    _currentRowKey.value = null\n  }\n\n  const setCurrentRowByKey = (key: string) => {\n    const { data, rowKey } = watcherData\n    const oldCurrentRow = currentRow.value\n    let _currentRow: T | null = null\n    if (rowKey.value) {\n      _currentRow =\n        (unref(data) || []).find(\n          (item) => getRowIdentity(item, rowKey.value) === key\n        ) ?? null\n    }\n    currentRow.value = _currentRow ?? null\n    instance.emit('current-change', currentRow.value, oldCurrentRow)\n  }\n\n  const updateCurrentRow = (_currentRow: T) => {\n    const oldCurrentRow = currentRow.value\n    if (_currentRow && _currentRow !== oldCurrentRow) {\n      currentRow.value = _currentRow\n      instance.emit('current-change', currentRow.value, oldCurrentRow)\n      return\n    }\n    if (!_currentRow && oldCurrentRow) {\n      currentRow.value = null\n      instance.emit('current-change', null, oldCurrentRow)\n    }\n  }\n\n  const updateCurrentRowData = () => {\n    const rowKey = watcherData.rowKey.value\n    // data 为 null 时，解构时的默认值会被忽略\n    const data = watcherData.data.value || []\n    const oldCurrentRow = currentRow.value\n    // 当 currentRow 不在 data 中时尝试更新数据\n    if (oldCurrentRow && !data.includes(oldCurrentRow)) {\n      if (rowKey) {\n        const currentRowKey = getRowIdentity(oldCurrentRow, rowKey)\n        setCurrentRowByKey(currentRowKey)\n      } else {\n        currentRow.value = null\n        instance.emit('current-change', null, oldCurrentRow)\n      }\n    } else if (_currentRowKey.value) {\n      // 把初始时下设置的 rowKey 转化成 rowData\n      setCurrentRowByKey(_currentRowKey.value)\n      restoreCurrentRowKey()\n    }\n  }\n\n  return {\n    setCurrentRowKey,\n    restoreCurrentRowKey,\n    setCurrentRowByKey,\n    updateCurrentRow,\n    updateCurrentRowData,\n    states: {\n      _currentRowKey,\n      currentRow,\n    },\n  }\n}\n\nexport default useCurrent\n"],"names":[],"mappings":"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"}