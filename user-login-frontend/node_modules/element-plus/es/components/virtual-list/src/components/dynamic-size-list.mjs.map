{"version":3,"file":"dynamic-size-list.mjs","sources":["../../../../../../../packages/components/virtual-list/src/components/dynamic-size-list.ts"],"sourcesContent":["import { throwError } from '@element-plus/utils'\nimport createList from '../builders/build-list'\nimport { isHorizontal } from '../utils'\nimport {\n  AUTO_ALIGNMENT,\n  CENTERED_ALIGNMENT,\n  DEFAULT_DYNAMIC_LIST_ITEM_SIZE,\n  END_ALIGNMENT,\n  SMART_ALIGNMENT,\n  START_ALIGNMENT,\n} from '../defaults'\n\nimport type { VirtualizedListProps } from '../props'\nimport type { ItemSize, ListCache, ListItem } from '../types'\n\ntype Props = VirtualizedListProps\n\nconst SCOPE = 'ElDynamicSizeList'\nconst getItemFromCache = (\n  props: Props,\n  index: number,\n  listCache: ListCache\n): ListItem => {\n  const { itemSize } = props\n  const { items, lastVisitedIndex } = listCache\n\n  if (index > lastVisitedIndex) {\n    let offset = 0\n    if (lastVisitedIndex >= 0) {\n      const item = items[lastVisitedIndex]\n      offset = item.offset + item.size\n    }\n\n    for (let i = lastVisitedIndex + 1; i <= index; i++) {\n      const size = (itemSize as ItemSize)(i)\n\n      items[i] = {\n        offset,\n        size,\n      }\n\n      offset += size\n    }\n\n    listCache.lastVisitedIndex = index\n  }\n\n  return items[index]\n}\n\nconst findItem = (props: Props, listCache: ListCache, offset: number) => {\n  const { items, lastVisitedIndex } = listCache\n\n  const lastVisitedOffset =\n    lastVisitedIndex > 0 ? items[lastVisitedIndex].offset : 0\n\n  if (lastVisitedOffset >= offset) {\n    return bs(props, listCache, 0, lastVisitedIndex, offset)\n  }\n  return es(props, listCache, Math.max(0, lastVisitedIndex), offset)\n}\n\n// bs stands for binary search which has approximately time complexity of O(Log n)\n// space complexity of O(1)\n// in this case we use it for search the offset of each item, since\n// the cached items' offset is monotonically increasing\nconst bs = (\n  props: Props,\n  listCache: ListCache,\n  low: number,\n  high: number,\n  offset: number\n) => {\n  while (low <= high) {\n    const mid = low + Math.floor((high - low) / 2)\n    const currentOffset = getItemFromCache(props, mid, listCache).offset\n\n    if (currentOffset === offset) {\n      return mid\n    } else if (currentOffset < offset) {\n      low = mid + 1\n    } else if (currentOffset > offset) {\n      high = mid - 1\n    }\n  }\n\n  return Math.max(0, low - 1)\n}\n\n// es stands for exponential search which has time complexity of O(Log n) and\n// space complexity of O(1) in the case of finding the boundary element.\n// the exponential indicator in this case is 2.\n// for more detail about exponential search click this link\n// https://www.freecodecamp.org/news/search-algorithms-exponential-search-explained/\n\nconst es = (\n  props: Props,\n  listCache: ListCache,\n  index: number,\n  offset: number\n) => {\n  const { total } = props\n  let exponent = 1\n\n  while (\n    index < total &&\n    getItemFromCache(props, index, listCache).offset < offset\n  ) {\n    index += exponent\n    exponent *= 2\n  }\n\n  return bs(\n    props,\n    listCache,\n    Math.floor(index / 2),\n    Math.min(index, total - 1),\n    offset\n  )\n}\n\nconst getEstimatedTotalSize = (\n  { total }: Props,\n  { items, estimatedItemSize, lastVisitedIndex }: ListCache\n) => {\n  let totalSizeOfMeasuredItems = 0\n\n  if (lastVisitedIndex >= total) {\n    lastVisitedIndex = total - 1\n  }\n\n  if (lastVisitedIndex >= 0) {\n    const item = items[lastVisitedIndex]\n    totalSizeOfMeasuredItems = item.offset + item.size\n  }\n\n  const numUnmeasuredItems = total - lastVisitedIndex - 1\n  const totalSizeOfUnmeasuredItems = numUnmeasuredItems * estimatedItemSize\n  return totalSizeOfMeasuredItems + totalSizeOfUnmeasuredItems\n}\n\nconst DynamicSizeList = createList({\n  name: 'ElDynamicSizeList',\n  getItemOffset: (props, index, listCache) =>\n    getItemFromCache(props, index, listCache).offset,\n\n  getItemSize: (_, index, { items }) => items[index].size,\n\n  getEstimatedTotalSize,\n\n  getOffset: (props, index, alignment, scrollOffset, listCache) => {\n    const { height, layout, width } = props\n\n    const size = (isHorizontal(layout) ? width : height) as number\n    const item = getItemFromCache(props, index, listCache)\n\n    const estimatedTotalSize = getEstimatedTotalSize(props, listCache)\n\n    const maxOffset = Math.max(\n      0,\n      Math.min(estimatedTotalSize - size, item.offset)\n    )\n    const minOffset = Math.max(0, item.offset - size + item.size)\n\n    if (alignment === SMART_ALIGNMENT) {\n      if (\n        scrollOffset >= minOffset - size &&\n        scrollOffset <= maxOffset + size\n      ) {\n        alignment = AUTO_ALIGNMENT\n      } else {\n        alignment = CENTERED_ALIGNMENT\n      }\n    }\n\n    switch (alignment) {\n      case START_ALIGNMENT: {\n        return maxOffset\n      }\n      case END_ALIGNMENT: {\n        return minOffset\n      }\n      case CENTERED_ALIGNMENT: {\n        return Math.round(minOffset + (maxOffset - minOffset) / 2)\n      }\n      case AUTO_ALIGNMENT:\n      default: {\n        if (scrollOffset >= minOffset && scrollOffset <= maxOffset) {\n          return scrollOffset\n        } else if (scrollOffset < minOffset) {\n          return minOffset\n        } else {\n          return maxOffset\n        }\n      }\n    }\n  },\n\n  getStartIndexForOffset: (props, offset, listCache) =>\n    findItem(props, listCache, offset),\n\n  getStopIndexForStartIndex: (props, startIndex, scrollOffset, listCache) => {\n    const { height, total, layout, width } = props\n\n    const size = (isHorizontal(layout) ? width : height) as number\n    const item = getItemFromCache(props, startIndex, listCache)\n    const maxOffset = scrollOffset + size\n\n    let offset = item.offset + item.size\n    let stopIndex = startIndex\n\n    while (stopIndex < total - 1 && offset < maxOffset) {\n      stopIndex++\n      offset += getItemFromCache(props, stopIndex, listCache).size\n    }\n\n    return stopIndex\n  },\n\n  initCache({ estimatedItemSize = DEFAULT_DYNAMIC_LIST_ITEM_SIZE }, instance) {\n    const cache = {\n      items: {},\n      estimatedItemSize,\n      lastVisitedIndex: -1,\n    } as ListCache\n\n    cache.clearCacheAfterIndex = (index: number, forceUpdate = true) => {\n      cache.lastVisitedIndex = Math.min(cache.lastVisitedIndex, index - 1)\n      instance.exposed?.getItemStyleCache(-1)\n\n      if (forceUpdate) {\n        instance.proxy?.$forceUpdate()\n      }\n    }\n\n    return cache\n  },\n\n  clearCache: false,\n\n  validateProps: ({ itemSize }) => {\n    if (process.env.NODE_ENV !== 'production') {\n      if (typeof itemSize !== 'function') {\n        throwError(\n          SCOPE,\n          `\n          itemSize is required as function, but the given value was ${typeof itemSize}\n        `\n        )\n      }\n    }\n  },\n})\n\nexport type DynamicSizeListInstance = InstanceType<typeof DynamicSizeList> &\n  unknown\nexport default DynamicSizeList\n"],"names":[],"mappings":"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"}