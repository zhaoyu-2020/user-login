{"version":3,"file":"useKeydown.mjs","sources":["../../../../../../../packages/components/tree/src/model/useKeydown.ts"],"sourcesContent":["import { onMounted, onUpdated } from 'vue'\nimport { useEventListener } from '@vueuse/core'\nimport { EVENT_CODE } from '@element-plus/constants'\nimport { useNamespace } from '@element-plus/hooks'\nimport { getEventCode } from '@element-plus/utils'\n\nimport type TreeStore from './tree-store'\nimport type { Ref } from 'vue'\nimport type { Nullable } from '@element-plus/utils'\n\ninterface UseKeydownOption {\n  el$: Ref<HTMLElement | null>\n}\nexport function useKeydown({ el$ }: UseKeydownOption, store: Ref<TreeStore>) {\n  const ns = useNamespace('tree')\n\n  onMounted(() => {\n    initTabIndex()\n  })\n\n  onUpdated(() => {\n    el$.value?.querySelectorAll('input[type=checkbox]').forEach((checkbox) => {\n      checkbox.setAttribute('tabindex', '-1')\n    })\n  })\n\n  function canNodeFocus(treeItems: HTMLElement[], nextIndex: number): boolean {\n    const currentNode = store.value.getNode(treeItems[nextIndex].dataset.key!)\n    return (\n      currentNode.canFocus &&\n      currentNode.visible &&\n      (currentNode.parent?.expanded || currentNode.parent?.level === 0)\n    )\n  }\n\n  const handleKeydown = (ev: KeyboardEvent): void => {\n    const currentItem = ev.target as HTMLDivElement\n    if (!currentItem.className.includes(ns.b('node'))) return\n    const code = getEventCode(ev)\n    const treeItems: HTMLElement[] = Array.from(\n      el$.value!.querySelectorAll(`.${ns.is('focusable')}[role=treeitem]`)\n    )\n    const currentIndex = treeItems.indexOf(currentItem)\n    let nextIndex\n    if ([EVENT_CODE.up, EVENT_CODE.down].includes(code)) {\n      ev.preventDefault()\n      if (code === EVENT_CODE.up) {\n        nextIndex =\n          currentIndex === -1\n            ? 0\n            : currentIndex !== 0\n              ? currentIndex - 1\n              : treeItems.length - 1\n        const startIndex = nextIndex\n        while (true) {\n          if (canNodeFocus(treeItems, nextIndex)) {\n            break\n          }\n\n          nextIndex--\n          if (nextIndex === startIndex) {\n            nextIndex = -1\n            break\n          }\n          if (nextIndex < 0) {\n            nextIndex = treeItems.length - 1\n          }\n        }\n      } else {\n        nextIndex =\n          currentIndex === -1\n            ? 0\n            : currentIndex < treeItems.length - 1\n              ? currentIndex + 1\n              : 0\n        const startIndex = nextIndex\n        while (true) {\n          if (canNodeFocus(treeItems, nextIndex)) {\n            break\n          }\n\n          nextIndex++\n          if (nextIndex === startIndex) {\n            nextIndex = -1\n            break\n          }\n          if (nextIndex >= treeItems.length) {\n            nextIndex = 0\n          }\n        }\n      }\n      nextIndex !== -1 && treeItems[nextIndex].focus()\n    }\n    if ([EVENT_CODE.left, EVENT_CODE.right].includes(code)) {\n      ev.preventDefault()\n      currentItem.click()\n    }\n    const hasInput = currentItem.querySelector(\n      '[type=\"checkbox\"]'\n    ) as Nullable<HTMLInputElement>\n    if (\n      [EVENT_CODE.enter, EVENT_CODE.numpadEnter, EVENT_CODE.space].includes(\n        code\n      ) &&\n      hasInput\n    ) {\n      ev.preventDefault()\n      hasInput.click()\n    }\n  }\n\n  useEventListener(el$, 'keydown', handleKeydown)\n\n  const initTabIndex = (): void => {\n    if (!el$.value) return\n    const treeItems = Array.from(\n      el$.value.querySelectorAll(`.${ns.is('focusable')}[role=treeitem]`)\n    )\n    const checkboxItems = Array.from(\n      el$.value.querySelectorAll('input[type=checkbox]')\n    )\n    checkboxItems.forEach((checkbox) => {\n      checkbox.setAttribute('tabindex', '-1')\n    })\n    const checkedItem = el$.value.querySelectorAll(\n      `.${ns.is('checked')}[role=treeitem]`\n    )\n    if (checkedItem.length) {\n      checkedItem[0].setAttribute('tabindex', '0')\n      return\n    }\n    treeItems[0]?.setAttribute('tabindex', '0')\n  }\n}\n"],"names":[],"mappings":"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"}